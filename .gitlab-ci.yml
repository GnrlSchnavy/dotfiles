stages:
  - validate
  - test
  - report

variables:
  CI: "true"
  DOTFILES_CI: "true"
  HOMEBREW_NO_AUTO_UPDATE: "1"
  HOMEBREW_NO_INSTALL_CLEANUP: "1"
  HOMEBREW_NO_ANALYTICS: "1"
  NONINTERACTIVE: "1"

validate:
  stage: validate
  image: alpine:latest
  script:
    - echo "Validating repository structure"
    - test -f "setup.sh" || (echo "setup.sh not found" && exit 1)
    - test -d "nix" || (echo "nix directory not found" && exit 1)
    - test -d "scripts" || (echo "scripts directory not found" && exit 1)
    - test -f "scripts/ci-setup.sh" || (echo "ci-setup.sh not found" && exit 1)
    - test -f "scripts/ci-verify.sh" || (echo "ci-verify.sh not found" && exit 1)
    - echo "Repository structure validation passed"
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^ci\/.*/
    - if: $CI_PIPELINE_SOURCE == "web"

test_macos_setup:
  stage: test
  tags:
    - macos
    - apple-silicon
  timeout: 60m
  variables:
    # Use isolated workspace - never touch real ~/.dotfiles
    TEST_HOME: "/tmp/dotfiles-test-$$"
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^ci\/.*/
      changes:
        - "**/*"
        - "!**.md"
        - "!docs/**"
    - if: $CI_PIPELINE_SOURCE == "web"
  before_script:
    - echo "System Information"
    - whoami
    - pwd
    - echo "Creating isolated test environment"
    - mkdir -p "$TEST_HOME"
  script:
    # Copy everything to isolated location and test there
    - cp -r . "$TEST_HOME/dotfiles-source"
    - cd "$TEST_HOME/dotfiles-source"
    - echo "Running setup with isolated HOME=$TEST_HOME"
    - chmod +x ./scripts/ci-setup.sh
    - HOME="$TEST_HOME" ./scripts/ci-setup.sh
    - echo "Running verification"
    - chmod +x ./scripts/ci-verify.sh
    - HOME="$TEST_HOME" ./scripts/ci-verify.sh
    - echo "Running health check"
    - cd "$TEST_HOME/.dotfiles"
    - ./scripts/check.sh
    - echo "Testing development workflow"
    - source "$TEST_HOME/.zprofile" || true
    - git --version
    - kubectl version --client || echo "kubectl not available"
    - command -v nvm && echo "nvm available" || echo "nvm not found"
    - command -v jenv && echo "jenv available" || echo "jenv not found"
    - echo "macOS setup test completed successfully"
  after_script:
    - echo "Cleaning up isolated test environment"
    - rm -rf "$TEST_HOME" || true

report:
  stage: report
  image: alpine:latest
  script:
    - echo "Pipeline Summary Report"
    - echo "All dotfiles installation testing completed"
    - echo "Report completed"
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^ci\/.*/
    - if: $CI_PIPELINE_SOURCE == "web"
  when: always